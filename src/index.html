<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Image Super Resolution - Windows AI Demo</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üñºÔ∏è Image Super Resolution</h1>
        <p class="subtitle">Powered by Windows AI APIs (NPU-accelerated)</p>
      </header>

      <div class="status-bar">
        <span class="status-label">Model Status:</span>
        <span id="modelStatus" class="status-value">Checking...</span>
        <button id="initModelBtn" class="btn btn-small" style="display: none;">Initialize Model</button>
      </div>

      <main>
        <div class="controls">
          <button id="selectImageBtn" class="btn btn-primary" disabled>
            üìÅ Select Image
          </button>
          
          <div class="scale-controls">
            <label for="scaleFactor">Scale Factor:</label>
            <input type="range" id="scaleFactor" min="1" max="8" value="2" step="1" />
            <span id="scaleValue" class="scale-value">2x</span>
          </div>
        </div>

        <div class="image-comparison-slider">
          <div class="comparison-container" id="comparisonContainer">
            <div class="placeholder" id="mainPlaceholder">
              <span>No image selected</span>
              <small>Click "Select Image" to choose a file</small>
            </div>
            
            <div class="processing" id="processingIndicator" style="display: none;">
              <div class="spinner"></div>
              <span>Processing with NPU...</span>
            </div>
            
            <div class="comparison-wrapper" id="comparisonWrapper" style="display: none;">
              <!-- Enhanced image (background) -->
              <img id="enhancedImage" class="comparison-image" />
              
              <!-- Original image (foreground, clipped) -->
              <div class="comparison-overlay" id="comparisonOverlay">
                <img id="originalImage" class="comparison-image" />
              </div>
              
              <!-- Slider handle -->
              <div class="comparison-slider" id="comparisonSlider">
                <div class="slider-line"></div>
                <div class="slider-handle">
                  <span class="slider-arrow left">‚óÄ</span>
                  <span class="slider-arrow right">‚ñ∂</span>
                </div>
              </div>
              
              <!-- Labels -->
              <div class="comparison-label label-original">Original</div>
              <div class="comparison-label label-enhanced">Enhanced</div>
            </div>
          </div>
          
          <div class="image-info-bar">
            <span id="originalInfo"></span>
            <span id="enhancedInfo"></span>
          </div>
        </div>

        <div class="result-message" id="resultMessage"></div>
      </main>

      <footer>
        <p>Built with Electron + Windows App SDK + winapp CLI</p>
        <p class="note">Requires Windows 11 Copilot+ PC with NPU for hardware acceleration</p>
      </footer>
    </div>

    <script>
      // DOM Elements
      const modelStatus = document.getElementById('modelStatus');
      const initModelBtn = document.getElementById('initModelBtn');
      const selectImageBtn = document.getElementById('selectImageBtn');
      const scaleFactor = document.getElementById('scaleFactor');
      const originalImage = document.getElementById('originalImage');
      const enhancedImage = document.getElementById('enhancedImage');
      const originalInfo = document.getElementById('originalInfo');
      const enhancedInfo = document.getElementById('enhancedInfo');
      const processingIndicator = document.getElementById('processingIndicator');
      const mainPlaceholder = document.getElementById('mainPlaceholder');
      const resultMessage = document.getElementById('resultMessage');
      const comparisonWrapper = document.getElementById('comparisonWrapper');
      const comparisonOverlay = document.getElementById('comparisonOverlay');
      const comparisonSlider = document.getElementById('comparisonSlider');
      const comparisonContainer = document.getElementById('comparisonContainer');

      let currentImagePath = null;
      let tempPath = null;
      let isDragging = false;
      let debounceTimer = null;
      let isProcessing = false;
      const scaleValue = document.getElementById('scaleValue');

      // Comparison slider functionality
      function setSliderPosition(percent) {
        // Use clip-path to reveal/hide the original image
        const clipRight = 100 - percent;
        comparisonOverlay.style.clipPath = `inset(0 ${clipRight}% 0 0)`;
        comparisonSlider.style.left = `${percent}%`;
      }

      function handleSliderMove(e) {
        if (!isDragging) return;
        const rect = comparisonContainer.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
        setSliderPosition(percent);
      }

      comparisonSlider.addEventListener('mousedown', () => isDragging = true);
      comparisonSlider.addEventListener('touchstart', () => isDragging = true);
      document.addEventListener('mouseup', () => isDragging = false);
      document.addEventListener('touchend', () => isDragging = false);
      document.addEventListener('mousemove', handleSliderMove);
      document.addEventListener('touchmove', handleSliderMove);

      // Also allow clicking anywhere on the comparison to move slider
      comparisonContainer.addEventListener('click', (e) => {
        if (comparisonWrapper.style.display !== 'none') {
          const rect = comparisonContainer.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
          setSliderPosition(percent);
        }
      });

      // Debounced enhance function
      function debounceEnhance(delay = 300) {
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          if (currentImagePath && !isProcessing) {
            processImage();
          }
        }, delay);
      }

      // Update scale value display when slider changes and trigger re-enhancement
      scaleFactor.addEventListener('input', () => {
        const val = scaleFactor.value;
        scaleValue.textContent = val === '1' ? '1x (Sharpen)' : `${val}x`;
        debounceEnhance(500);
      });

      // Initialize the app
      async function init() {
        // Get temp directory
        tempPath = await window.superResolution.getTempPath();
        
        // Check model status
        await checkModelStatus();
      }

      async function checkModelStatus() {
        const readyState = await window.superResolution.getReadyState();
        console.log('Ready state:', readyState);
        
        // Handle null/undefined
        if (!readyState || readyState === 'undefined' || readyState === 'Unknown') {
          modelStatus.textContent = '‚ö†Ô∏è Unable to determine status';
          modelStatus.className = 'status-value error';
          selectImageBtn.disabled = true;
          initModelBtn.style.display = 'inline-block';
          return;
        }
        
        if (readyState === 'Ready') {
          modelStatus.textContent = '‚úÖ Ready';
          modelStatus.className = 'status-value ready';
          selectImageBtn.disabled = false;
          initModelBtn.style.display = 'none';
          resultMessage.textContent = '';
        } else if (readyState === 'NotReady') {
          modelStatus.textContent = '‚è≥ Model needs initialization';
          modelStatus.className = 'status-value not-ready';
          initModelBtn.style.display = 'inline-block';
          selectImageBtn.disabled = true;
        } else if (readyState === 'NotSupportedOnCurrentSystem' || (readyState && readyState.includes && readyState.includes('NotSupported'))) {
          modelStatus.textContent = '‚ùå Not Supported on This Device';
          modelStatus.className = 'status-value error';
          selectImageBtn.disabled = true;
          initModelBtn.style.display = 'none';
          resultMessage.innerHTML = `
            <strong>‚ö†Ô∏è NPU Required</strong><br>
            Image Super Resolution requires a <strong>Copilot+ PC</strong> with a Neural Processing Unit (NPU).<br>
            <small>This AI feature uses on-device machine learning that requires specialized hardware for acceleration.</small>
          `;
          resultMessage.className = 'result-message error';
        } else if (readyState === 'DisabledByUser') {
          modelStatus.textContent = '‚ö†Ô∏è AI Features Disabled';
          modelStatus.className = 'status-value error';
          selectImageBtn.disabled = true;
          initModelBtn.style.display = 'none';
          resultMessage.innerHTML = `
            <strong>AI Features Disabled</strong><br>
            Please enable AI features in Windows Settings:<br>
            <small>Settings ‚Üí Privacy & security ‚Üí AI</small>
          `;
          resultMessage.className = 'result-message error';
        } else {
          modelStatus.textContent = `‚ö†Ô∏è ${readyState}`;
          modelStatus.className = 'status-value error';
          selectImageBtn.disabled = true;
        }
      }

      initModelBtn.addEventListener('click', async () => {
        initModelBtn.disabled = true;
        modelStatus.textContent = '‚è≥ Initializing model...';
        resultMessage.textContent = '';
        
        const result = await window.superResolution.ensureModelReady();
        
        if (result === 'Ready') {
          await checkModelStatus();
        } else {
          // Check if error indicates NPU not available
          if (result.includes('NPU') || result.includes('Copilot+') || result.includes('not support') || result.includes('hardware')) {
            modelStatus.textContent = '‚ùå Not Supported on This Device';
            modelStatus.className = 'status-value error';
            initModelBtn.style.display = 'none';
            resultMessage.innerHTML = `
              <strong>‚ö†Ô∏è NPU Required</strong><br>
              ${result.replace('Error: ', '')}<br>
              <small>This AI feature uses on-device machine learning that requires a Copilot+ PC with specialized NPU hardware.</small>
            `;
            resultMessage.className = 'result-message error';
          } else {
            modelStatus.textContent = '‚ùå Initialization Failed';
            modelStatus.className = 'status-value error';
            resultMessage.textContent = result;
            resultMessage.className = 'result-message error';
            initModelBtn.disabled = false;
          }
        }
      });

      selectImageBtn.addEventListener('click', async () => {
        const filePath = await window.superResolution.selectImage();
        
        if (filePath) {
          currentImagePath = filePath;
          
          // Hide comparison, show placeholder with loading state
          comparisonWrapper.style.display = 'none';
          mainPlaceholder.innerHTML = '<span>Loading image...</span>';
          mainPlaceholder.style.display = 'flex';
          
          // Load the original image
          originalImage.src = `file://${filePath}`;
          
          // Wait for image to load to get dimensions then auto-enhance
          originalImage.onload = () => {
            originalInfo.textContent = `Original: ${originalImage.naturalWidth} √ó ${originalImage.naturalHeight}`;
            // Auto-enhance after loading
            processImage();
          };
          
          // Reset enhanced info
          enhancedInfo.textContent = '';
          resultMessage.textContent = '';
        }
      });

      // Process image function (called automatically)
      async function processImage() {
        if (!currentImagePath || isProcessing) return;
        
        isProcessing = true;
        selectImageBtn.disabled = true;
        
        // Show processing indicator
        mainPlaceholder.style.display = 'none';
        comparisonWrapper.style.display = 'none';
        processingIndicator.style.display = 'flex';
        resultMessage.textContent = '';
        
        const scale = parseInt(scaleFactor.value);
        const timestamp = Date.now();
        const outputPath = `${tempPath}\\enhanced_${timestamp}.png`;
        
        console.log('Processing image:', { currentImagePath, outputPath, scale });
        
        try {
          const result = await window.superResolution.scaleImage(
            currentImagePath,
            outputPath,
            scale
          );
          
          console.log('Scale result:', result);
          processingIndicator.style.display = 'none';
          
          // Handle null/undefined result
          if (!result) {
            mainPlaceholder.style.display = 'flex';
            mainPlaceholder.innerHTML = '<span>Error: No response from image scaler</span>';
            resultMessage.textContent = 'Error: No response from image scaler';
            resultMessage.className = 'result-message error';
            isProcessing = false;
            selectImageBtn.disabled = false;
            return;
          }
          
          if (result.success) {
            // Load enhanced image and show comparison slider
            enhancedImage.src = `file://${outputPath}?t=${timestamp}`;
            
            enhancedImage.onload = () => {
              // Show the comparison wrapper
              comparisonWrapper.style.display = 'block';
              mainPlaceholder.style.display = 'none';
              
              // Reset slider to middle
              setSliderPosition(50);
              
              // Update info
              enhancedInfo.textContent = `Enhanced: ${result.scaledWidth} √ó ${result.scaledHeight}`;
            };
            
            resultMessage.textContent = result.message;
            resultMessage.className = 'result-message success';
          } else {
            mainPlaceholder.style.display = 'flex';
            mainPlaceholder.innerHTML = `<span>Error</span><small>${result.message}</small>`;
            resultMessage.textContent = `Error: ${result.message}`;
            resultMessage.className = 'result-message error';
          }
        } catch (error) {
          processingIndicator.style.display = 'none';
          mainPlaceholder.style.display = 'flex';
          mainPlaceholder.innerHTML = `<span>Error</span><small>${error.message}</small>`;
          resultMessage.textContent = `Error: ${error.message}`;
          resultMessage.className = 'result-message error';
        }
        
        isProcessing = false;
        selectImageBtn.disabled = false;
      }

      // Initialize on load
      init();
    </script>
  </body>
</html>
